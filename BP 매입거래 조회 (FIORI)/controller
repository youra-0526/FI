```
sap.ui.define([
    "sap/ui/core/mvc/Controller",
    "sap/ui/model/odata/v2/ODataModel",
    "sap/ui/model/json/JSONModel",
    "sap/ui/model/Filter",              // ğŸ”¥ ì¶”ê°€ë¨: í•„í„° ê¸°ëŠ¥
    "sap/ui/model/FilterOperator",
    "sap/m/MessageToast"
   
], function (Controller, ODataModel, JSONModel, Filter, FilterOperator, MessageToast) {
    "use strict";


    return Controller.extend("zsair.bpsumchart.controller.bpsum_chart", {
         // ğŸ”½ ì—¬ê¸°ì— ìœ„ì¹˜
    formatAmountWithComma: function (sValue) {
        if (!sValue) return "0";
        return Number(sValue).toLocaleString();
    },
    
        onInit: function () {
            var oODataModel = new ODataModel("/sap/opu/odata/sap/ZVSAIR_BPVIEW01_SRV/");
            this._detailModel = new ODataModel("/sap/opu/odata/sap/ZCDS_ITEM02_20_CDS/");
            
            this._oODataModel = oODataModel;

            // ğŸŸ¨ [ìˆ˜ì •] ì´ˆê¸° ì¡°íšŒ ì œê±°í•˜ê³  ê¸°ë³¸ê°’ë§Œ ì„¤ì •
            var oView = this.getView();
            oView.byId("yearSelect").setSelectedKey("2025");
            oView.byId("monthSelect").setSelectedKey("01");
        },

        onSearchYearMonth: function () {
            var oView = this.getView();
            var sYear = oView.byId("yearSelect").getSelectedKey();
            var sMonth = oView.byId("monthSelect").getSelectedKey();

            // ğŸŸ¨ [ì¶”ê°€] ì¡°íšŒì¡°ê±´ ë¯¸ì…ë ¥ ì‹œ ê²½ê³  ë©”ì‹œì§€
            if (!sYear || !sMonth) {
                MessageToast.show("ì¡°íšŒì¡°ê±´ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            this._loadChartData(sYear, sMonth);
            this._loadTableData(sYear, sMonth); // âœ… í•˜ë‹¨ í…Œì´ë¸” ì¶”ê°€: ìƒì„¸ ì¡°íšŒ í˜¸ì¶œ

        },
        _loadChartData: function (sYear, sMonth) {
            var oView = this.getView();
            var oODataModel = this._oODataModel;
            var aFilters = [
                new Filter("Gjahr", FilterOperator.EQ, sYear),
                new Filter("Zmonat", FilterOperator.EQ, sMonth)
            ];

            // ğŸ” í•„í„° ë¡œê·¸
            console.log("â–¶ í•„í„° ì¡°ê±´ í™•ì¸:", sYear, sMonth);
            console.log("â–¶ ìš”ì²­ì— ì ìš©ëœ í•„í„° ë°°ì—´:", aFilters);

            this._oODataModel.read("/BPSearchsumSet", {
                filters: aFilters,
                success: function (oData) {

                    // âœ… ì½˜ì†”ì— ì°ì–´ì„œ ë°ì´í„° êµ¬ì¡° í™•ì¸
                    console.log("ğŸ“Š ë°”ì¸ë”©í•  ë°ì´í„° í™•ì¸:", oData);
                    console.log("ğŸ“¦ results ë°°ì—´:", oData.results);


                    if (!oData.results.length) {
                        // ğŸ”¥ ì´ì „ ë°ì´í„° ì œê±°
                        const oEmptyModel = new JSONModel({ BPSearchsumSet: [] });
                        oView.byId("idVizFrame").setModel(oEmptyModel); 

                        MessageToast.show("ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    // ğŸ”¥ ìˆ«ì ë³€í™˜ í•„ìˆ˜!
                    oData.results.forEach(function (item) {
                        item.Totaldmbtr = Number(item.Totaldmbtr);
                    });

                     // ğŸŸ§ ì „ì²´ ë°ì´í„° ì €ì¥ (íŒì—…ì—ì„œ BP í´ë¦­ ì‹œ ì‚¬ìš©)
                    this._allChartData = oData.results;
                    console.log("ğŸ“¦ ì „ì²´ ì°¨íŠ¸ ë°ì´í„° ì €ì¥ë¨:", this._allChartData);

                    const oJsonModel = new JSONModel({
                        BPSearchsumSet: oData.results
                    });

                    // â›” alias ì•ˆ ì¤Œ! ê¸°ë³¸ ëª¨ë¸ë¡œ VizFrameì— ë°”ì¸ë”©
                    oView.byId("idVizFrame").setModel(oJsonModel);

                    this._loadBpRanking(oData.results); // âœ… BP ìˆœìœ„ ê³„ì‚° í˜¸ì¶œ
                }.bind(this),
                
                error: function () {
                    MessageToast.show("ì¡°íšŒ ì‹¤íŒ¨!");
                },
                refresh: true // âœ… ê¼­ ì¶”ê°€
            });
        },

          _loadTableData: function (sYear, sMonth) {  // í•˜ë‹¨ í…Œì´ë¸” ì¶”ê°€: ìƒì„¸ í…Œì´ë¸” ë¡œë”© í•¨ìˆ˜
            var oView = this.getView();
            var aFilters = [
                new Filter("Gjahr", FilterOperator.EQ, sYear),
                new Filter("Zmonat", FilterOperator.EQ, sMonth)
            ];

            this._detailModel.read("/BPDetailSet", {
                filters: aFilters,
                success: function (oData) {
                    console.log("ğŸ“¦ ì„¸ë¶€ ë°ì´í„°:", oData.results); // 
                    console.log("í…Œì´ë¸” ìƒ˜í”Œ ë°ì´í„°:", oData.results[0]);
                    const oDetailModel = new JSONModel({ DetailSet: oData.results });
                    oView.byId("detailTable").setModel(oDetailModel, "detail"); // 
                  // BPëª… ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
            const bpnames = oData.results.map(x => x.BpName).filter(Boolean);
            const uniqueBpnames = Array.from(new Set(bpnames));

            // BPëª… ë“œë¡­ë‹¤ìš´ì— ì„¸íŒ…
            var oSelect = oView.byId("detailBpnameSelect");
            oSelect.removeAllItems();
            oSelect.addItem(new sap.ui.core.Item({ key: "ALL", text: "ì „ì²´" }));
            uniqueBpnames.forEach(bp => {
                oSelect.addItem(new sap.ui.core.Item({ key: bp, text: bp }));
            console.log("ë“œë¡­ë‹¤ìš´ì— ì¶”ê°€ëœ BPëª…:", bp);
            });
            oSelect.setSelectedKey("ALL");

            // í•„í„°ë§ ìœ„í•œ ì›ë³¸ ì €ì¥
            this._allDetailRows = oData.results;
        }.bind(this),
        error: function () {
            sap.m.MessageToast.show("í•˜ë‹¨ ì„¸ë¶€ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨");
        },
        refresh: true
    });
},
        onDetailBpnameChange: function (oEvent) {
    var sKey = oEvent.getSource().getSelectedKey();
    var oView = this.getView();
    var aAll = this._allDetailRows || [];
    var aFiltered = (sKey === "ALL") ? aAll : aAll.filter(x => x.BpName === sKey);

    var oDetailModel = new JSONModel({ DetailSet: aFiltered });
    oView.byId("detailTable").setModel(oDetailModel, "detail");
},
         
          // ì¤‘ë³µ BP ì œê±° ë° ê±°ë˜ê¸ˆì•¡ ëˆ„ì  ìˆœìœ„ ê³„ì‚° í•¨ìˆ˜
         _loadBpRanking: function (aData) {
            const bpMap = new Map();
            aData.forEach(function (item) {
                const bp = item.Bpname;
                const amount = Number(item.Totaldmbtr);
                if (bpMap.has(bp)) {
                    bpMap.get(bp).Totaldmbtr += amount;
                } else {
                    bpMap.set(bp, {
                        Bpname: bp,
                        Totaldmbtr: amount
                    });
                }
            });

            const sorted = Array.from(bpMap.values()).sort((a, b) => b.Totaldmbtr - a.Totaldmbtr);
            const ranked = sorted.map((item, index) => ({
                Rank: index + 1,
                Bpname: item.Bpname,
                Totaldmbtr: item.Totaldmbtr.toLocaleString()
            }));

            const oRankModel = new JSONModel({ TopBpList: ranked });
            this.getView().setModel(oRankModel, "rank");
        },

onChartClick: function (oEvent) {
     console.log("ì°¨íŠ¸ í´ë¦­ë¨!", oEvent);

    const paramData = oEvent.getParameter("data");
    if (!paramData || !paramData[0] || !paramData[0].data) {
        console.log("ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ or ì´ë²¤íŠ¸ ë°ì´í„° ì—†ìŒ");
        return;
    }
    const oContext = paramData[0].data;

    // BPëª… ì¶”ì¶œ (ì°¨íŠ¸ Dimension name="BP" ì´ë¯€ë¡œ ëŒ€ë¬¸ì "BP")
    const sBpName = oContext["BP"];
    console.log("í´ë¦­ëœ BPëª…:", sBpName);

    if (!sBpName) {
        console.log("BPëª… ì—†ìŒ");
        return;
    }

    // BPëª…ìœ¼ë¡œ _allChartDataì—ì„œ í•´ë‹¹ BP ë°ì´í„° ì°¾ê¸° (í•„ë“œëª… Bpname ê³ ì •)
    const found = this._allChartData.find(item => item.Bpname === sBpName);

    if (!found) {
        console.log("í•´ë‹¹ BPë¥¼ ë°ì´í„°ì—ì„œ ì°¾ì§€ ëª»í•¨", sBpName, this._allChartData.map(x => x.Bpname));
        return;
    }

    // ê±°ë˜ê±´ìˆ˜, ê±°ë˜ ì‹œì‘ í›„ ê²½ê³¼ì¼ ì§‘ê³„
    const bpItems = this._allChartData.filter(item => item.Bpname === sBpName);
    // ê±°ë˜ ê±´ìˆ˜
    const totalCount = bpItems.length;

    // ğŸ”µ ê±°ë˜ ì‹œì‘ì¼ ê³„ì‚° (Budat ì¤‘ ê°€ì¥ ê³¼ê±°)
    // (Budatì´ 'YYYYMMDD' ë¬¸ìí˜•íƒœë¼ë©´ new Dateë¡œ ë³€í™˜)
    let firstDate;
    if (bpItems.length > 0) {
        firstDate = new Date(
            bpItems
                .map(i => i.Budat)
                .map(s => s.length === 8 ? `${s.substr(0,4)}-${s.substr(4,2)}-${s.substr(6,2)}` : s)
                .map(s => new Date(s))
                .sort((a, b) => a - b)[0]
        );
    }
    // ì˜¤ëŠ˜ ë‚ ì§œ
    const now = new Date();
    // ê²½ê³¼ì¼ ê³„ì‚°
    let daysSinceFirstTransaction = "-";
    if (firstDate && !isNaN(firstDate)) {
        const diffMs = now - firstDate;
        daysSinceFirstTransaction = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    }

    // íŒì—…ì— ë„˜ê¸¸ ìš”ì•½ì •ë³´
    const oSummary = {
        Bpid: found.Bpid,
        Bpname: sBpName,
        TotalCount: totalCount,
        DaysSinceFirstTransaction: daysSinceFirstTransaction
    };
    const oModel = new JSONModel({ SelectedBP: oSummary });
    this.getView().setModel(oModel, "bpSummary");
    this._openDialog();
},

        _openDialog: function () {
            const oDialog = this.getView().byId("bpSummaryDialog");
            console.log("âœ… Dialog ì˜¤í”ˆ ì‹œë„!", oDialog);
            if (oDialog) {
                oDialog.open();
            } else {
                console.log("âŒ Dialogë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”");
            }
        },

        onDialogClose: function () {
            const oDialog = this.getView().byId("bpSummaryDialog");
            if (oDialog) {
                oDialog.close();
            }
        }
    });
});

    
